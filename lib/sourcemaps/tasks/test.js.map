{"version":3,"sources":["tasks/test.ts"],"names":[],"mappings":"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","file":"../../tasks/test.js","sourcesContent":["import * as _ from 'lodash';\r\nimport * as chalk from 'chalk';\r\nimport { TaskCallback, Gulp } from 'gulp';\r\n// import * as path from 'path';\r\nimport { Src, ITask, ITaskInfo, Operation, task, ITaskContext, RunWay } from 'development-core';\r\n// import * as chalk from 'chalk';\r\nimport * as karma from 'karma';\r\nimport * as fs from 'fs';\r\nimport * as path from 'path';\r\nconst glob = require('glob');\r\nconst mkdirp = require('mkdirp');\r\nimport * as url from 'url';\r\n// import * as mocha from 'gulp-mocha';\r\nimport { IWebTaskOption, KarmaJspmOption, KarmaJspm } from '../WebTaskOption';\r\n\r\n@task({\r\n    // order: total => { return { value: 2 / total, runWay: RunWay.parallel } },\r\n    oper: Operation.default | Operation.test\r\n})\r\nexport class KarmaTest implements ITask {\r\n    constructor(private info: ITaskInfo) {\r\n    }\r\n    getInfo() {\r\n        this.info.name = this.info.name || 'web-test';\r\n        return this.info;\r\n    }\r\n    setup(ctx: ITaskContext, gulp: Gulp) {\r\n        let option = (<IWebTaskOption>ctx.option).karma || {};\r\n        // console.log('web test:----------------------\\n', ctx.getRootPath());\r\n        let tkn = ctx.subTaskName(this.getInfo());\r\n        gulp.task(tkn, (callback: TaskCallback) => {\r\n            let karmaConfigFile = option.configFile || path.join(ctx.getRootPath(), './karma.conf.js');\r\n            karmaConfigFile = ctx.toRootPath(karmaConfigFile);\r\n            let cfg: karma.ConfigOptions = {};\r\n            // get config.\r\n            require(karmaConfigFile)({\r\n                set(config) {\r\n                    cfg = _.extend(cfg, config);\r\n                }\r\n            });\r\n            if (option.config) {\r\n                cfg = option.config(ctx);\r\n            }\r\n\r\n            cfg = <karma.ConfigOptions>_.extend(cfg, { singleRun: ctx.env.release || ctx.env.deploy || ctx.env.watch !== true });\r\n            if (option.basePath) {\r\n                cfg.basePath = ctx.toStr(option.basePath);\r\n            } else if (_.isUndefined(cfg.basePath)) {\r\n                cfg.basePath = ctx.getDist();\r\n            }\r\n\r\n            cfg.basePath = ctx.toRootPath(cfg.basePath);\r\n\r\n            if (option.jspm) {\r\n                cfg.files = cfg.files || [];\r\n                cfg = this.initkarmaJspmPlugin(cfg, ctx);\r\n            }\r\n\r\n            let serve = new karma.Server(\r\n                cfg,\r\n                (code: number) => {\r\n                    if (code === 1) {\r\n                        console.log(chalk.red('Unit Test failures, exiting process'), ', code:', chalk.cyan(<any>code));\r\n                        callback(<any>'Unit Test failures, exiting process');\r\n                    } else {\r\n                        console.log('Unit Tests passed', ', code:', chalk.cyan(<any>code));\r\n                        callback();\r\n                    }\r\n                });\r\n\r\n            serve.start();\r\n        });\r\n\r\n        return tkn;\r\n    }\r\n\r\n    getRelativePaths(ctx: ITaskContext, rootpath: string, prefix = '') {\r\n        let paths: any = {};\r\n        let bundleDest = ctx.getDist();\r\n        let dir = fs.readdirSync(bundleDest);\r\n        _.each(dir, (d: string) => {\r\n\r\n            let sf = path.join(bundleDest, d);\r\n            let f = fs.lstatSync(sf);\r\n            if (f.isDirectory()) {\r\n                let p = '/' + d + '/*';\r\n                paths[p] = prefix + ctx.toUrl(rootpath, path.join(bundleDest, p));\r\n            }\r\n        });\r\n        let p = '*'\r\n        paths[p] = prefix + ctx.toUrl(rootpath, path.join(bundleDest, p));\r\n        // let jpk = <string>option.jspmPackages;\r\n        // let jp = path.basename(jpk) + '/*';\r\n        // paths[jp] = self.toUrl(rootpath, path.join(jpk, jp));\r\n\r\n        return paths;\r\n    }\r\n\r\n\r\n    initkarmaJspmPlugin(cfg: karma.ConfigOptions, ctx: ITaskContext): karma.ConfigOptions {\r\n        let option = (<IWebTaskOption>ctx.option).karma || {};\r\n        let pkg = ctx.getPackage();\r\n\r\n        let karmajspm: KarmaJspmOption;\r\n        if (_.isFunction(option.jspm)) {\r\n            karmajspm = option.jspm(ctx);\r\n        } else if (_.isBoolean(karma)) {\r\n            karmajspm = {};\r\n        } else {\r\n            karmajspm = option.jspm;\r\n        }\r\n        let jspmcfg: KarmaJspm = cfg['jspm'] || {};\r\n\r\n        let adapterfile = ctx.toUrl(this.checkAdapter(karmajspm, ctx));\r\n\r\n        if (karmajspm.packages) {\r\n            jspmcfg.packages = ctx.toRootPath(ctx.toStr(karmajspm.packages));\r\n        } else {\r\n            if (!jspmcfg.packages && pkg.jspm && pkg.jspm.directories) {\r\n                jspmcfg.packages = ctx.toRootPath(pkg.jspm.directories.packages);\r\n            } else if (jspmcfg.packages) {\r\n                jspmcfg.packages = ctx.toRootPath(jspmcfg.packages);\r\n            }\r\n        }\r\n        if (karmajspm.config) {\r\n            jspmcfg.config = ctx.toDistSrc(ctx.toSrc(karmajspm.config));\r\n        } else {\r\n            if (!jspmcfg.config && pkg.jspm) {\r\n                jspmcfg.config = ctx.toRootPath(pkg.jspm.configFile);\r\n            } else if (jspmcfg.config) {\r\n                jspmcfg.config = ctx.toDistSrc(jspmcfg.config);\r\n            }\r\n        }\r\n\r\n        jspmcfg.config = _.isString(jspmcfg.config) ? ctx.toUrl(jspmcfg.config) : _.map(jspmcfg.config, it => ctx.toUrl(it));\r\n\r\n        jspmcfg.baseURL = ctx.toStr(karmajspm.baseURL || jspmcfg.baseURL || '');\r\n        if (!_.isUndefined(karmajspm.cachePackages)) {\r\n            jspmcfg.cachePackages = karmajspm.cachePackages;\r\n        }\r\n\r\n        let relpkg = ctx.toUrl(cfg.basePath, jspmcfg.packages);\r\n        let resetBase = false;\r\n        if (/^\\.\\./.test(relpkg)) {\r\n            resetBase = true;\r\n            let root = cfg.basePath = ctx.getRootPath();\r\n            jspmcfg.paths = this.getRelativePaths(ctx, cfg.basePath); // , 'base/');\r\n            let rlpk = ctx.toUrl(root, jspmcfg.packages) + '/*';\r\n            let jspmpk = path.basename(jspmcfg.packages) + '/*';\r\n            jspmcfg.paths['/' + jspmpk] = 'base/' + rlpk;\r\n\r\n\r\n            let res: Src = ctx.to(karmajspm.resource) || ['public', 'asserts'];\r\n            let relpth = ctx.toUrl(root, ctx.getDist());\r\n            cfg.proxies = cfg.proxies || {};\r\n            cfg.files = cfg.files || [];\r\n            _.each(_.isString(res) ? [res] : res, r => {\r\n                cfg.files.push({ pattern: ctx.toUrl(root, ctx.toDistPath(r)) + '/**', included: false });\r\n\r\n                let abr = /^\\//.test(r) ? ('base' + r) : ('base/' + r);\r\n                cfg.proxies[abr] = url.resolve(relpth, r);\r\n            });\r\n\r\n            // jspmcfg.paths = jspmcfg.paths || {};\r\n            // jspmcfg.baseURL = ctx.toUrl(root, ctx.getDist());\r\n            // let rlpk = ctx.toUrl(root, jspmcfg.packages) + '/*';\r\n            // jspmcfg.paths[rlpk] = '/base/' + rlpk;\r\n            console.log('paths: ', jspmcfg.paths);\r\n\r\n            cfg.proxies = _.extend(cfg.proxies, jspmcfg.paths);\r\n            cfg.proxies[path.basename(jspmcfg.packages)] = ctx.toUrl(root, jspmcfg.packages);\r\n            console.log('proxies: ', cfg.proxies);\r\n        }\r\n\r\n        jspmcfg.loadFiles = jspmcfg.loadFiles || [];\r\n        jspmcfg.serveFiles = jspmcfg.serveFiles || [];\r\n\r\n        if (karmajspm.loadFiles) {\r\n            jspmcfg.loadFiles = jspmcfg.loadFiles.concat(_.isFunction(karmajspm.loadFiles) ? karmajspm.loadFiles(ctx) : karmajspm.loadFiles);\r\n        }\r\n        if (karmajspm.serveFiles) {\r\n            jspmcfg.serveFiles = jspmcfg.serveFiles.concat(_.isFunction(karmajspm.serveFiles) ? karmajspm.serveFiles(ctx) : karmajspm.serveFiles);\r\n        }\r\n\r\n        cfg.plugins = _.filter(cfg.plugins || [], it => it !== 'karma-jspm');\r\n        cfg.frameworks = _.filter(cfg.frameworks || [], it => it !== 'jspm');\r\n        // clean.\r\n\r\n        cfg.plugins = cfg.plugins.concat(_.map(cfg.frameworks, it => 'karma-' + it.toLowerCase()));\r\n        cfg.plugins = cfg.plugins.concat(_.map(cfg.reporters, it => {\r\n            let packname = 'karma-' + it.toLowerCase() + '-reporter'\r\n            if (pkg.dependencies[packname] || pkg.devDependencies[packname]) {\r\n                return packname;\r\n            }\r\n            return 'karma-' + it;\r\n        }));\r\n        cfg.plugins = cfg.plugins.concat(_.map(cfg.browsers, it => {\r\n            let packname = 'karma-' + it.toLowerCase() + '-launcher';\r\n            if (pkg.dependencies[packname] || pkg.devDependencies[packname]) {\r\n                return packname;\r\n            }\r\n            return 'karma-' + it;\r\n        }));\r\n        cfg.plugins = _.uniq(cfg.plugins);\r\n\r\n\r\n\r\n        let initJspm: any = (files: (karma.FilePattern | string)[], basePath: string, jspm: KarmaJspm, client, emitter) => {\r\n            console.log('--------------------init karma jspm---------------------\\n', 'base path:', chalk.cyan(basePath));\r\n            jspm = jspm || {}\r\n\r\n            jspm = _.extend(jspm || {}, jspmcfg);\r\n\r\n            client.jspm = client.jspm || {};\r\n            if (jspm.paths !== undefined && typeof jspm.paths === 'object') {\r\n                client.jspm.paths = jspm.paths;\r\n            }\r\n            if (jspm.meta !== undefined && typeof jspm.meta === 'object') {\r\n                client.jspm.meta = jspm.meta;\r\n            }\r\n            // Pass on options to client\r\n            client.jspm.useBundles = jspm.useBundles;\r\n            client.jspm.stripExtension = jspm.stripExtension;\r\n\r\n            let baseURL = jspm.baseURL;\r\n            client.jspm.baseURL = baseURL || '';\r\n\r\n            console.log('base URL:', chalk.cyan(baseURL));\r\n            let fileBasePath = ctx.toUrl(resetBase ? ctx.getDist() : path.join(basePath, baseURL));\r\n            console.log('fileBasePath', fileBasePath);\r\n\r\n            let packagesPath = ctx.toUrl(jspm.packages);\r\n            let browserPath = ctx.toUrl(ctx.toRootPath(ctx.toStr(jspm.browser || '')));\r\n            let configPaths: string[] = Array.isArray(jspm.config) ? <string[]>jspm.config : [<string>jspm.config];\r\n            // Add SystemJS loader and jspm config\r\n\r\n\r\n            Array.prototype.unshift.apply(files,\r\n                configPaths.map((configPath) => {\r\n                    return createPattern(configPath)\r\n                })\r\n            );\r\n\r\n            // Needed for JSPM 0.17 beta\r\n            if (jspm.browser) {\r\n                files.unshift(createPattern(browserPath));\r\n            }\r\n\r\n            files.unshift(createPattern(adapterfile));\r\n            let sysjs = karmajspm.systemjs ? ctx.toSrc(karmajspm.systemjs) : ['system-polyfills', 'system'];\r\n            _.each(_.isArray(sysjs) ? sysjs : [sysjs], sf => {\r\n                files.unshift(createPattern(ctx.toUrl(getPackageFilePath(packagesPath, sf))));\r\n            });\r\n\r\n            function addExpandedFiles() {\r\n                client.jspm.expandedFiles = _.flatten(_.map(jspm.loadFiles, file => {\r\n                    let flname = path.join(fileBasePath, _.isString(file) ? file : file.pattern);\r\n                    files.push(createServedPattern(ctx.toUrl(flname), _.isString(file) ? null : file));\r\n                    return _.map(glob.sync(flname), (fm: string) => ctx.toUrl(fileBasePath, fm));\r\n                }));\r\n\r\n                console.log('expandedFiles:', client.jspm.expandedFiles);\r\n            }\r\n            addExpandedFiles();\r\n\r\n            emitter.on('file_list_modified', addExpandedFiles);\r\n\r\n            // Add served files to files array\r\n            _.each(jspm.serveFiles, file => {\r\n                files.push(createServedPattern(ctx.toUrl(path.join(fileBasePath, _.isString(file) ? file : file.pattern))));\r\n            });\r\n\r\n            // Allow Karma to serve all files within jspm_packages.\r\n            // This allows jspm/SystemJS to load them\r\n            var jspmPattern = createServedPattern(\r\n                ctx.toUrl(path.join(packagesPath, '!(system-polyfills.js|system.js|system-polyfills.src.js|system.src.js)/**')), { nocache: jspm.cachePackages !== true }\r\n            );\r\n            jspmPattern.watched = false;\r\n            files.push(jspmPattern);\r\n\r\n            console.log('------------------------complete jspm pattern:\\n', files);\r\n        };\r\n        initJspm.$inject = ['config.files', 'config.basePath', 'config.jspm', 'config.client', 'emitter'];\r\n\r\n        cfg.frameworks.unshift('jspmdev');\r\n        cfg.plugins.unshift({\r\n            'framework:jspmdev': ['factory', initJspm]\r\n        });\r\n\r\n        return cfg;\r\n    }\r\n\r\n\r\n    getDefaultAdapter() {\r\n        return {\r\n            name: 'adapter',\r\n            template: `\r\n(function(karma, System) {\r\n    if (!System) {\r\n        throw new Error('SystemJS was not found. Please make sure you have ' +\r\n            'initialized jspm via installing a dependency with jspm, ' +\r\n            'or by running \"jspm dl-loader\".');\r\n    }\r\n\r\n\r\n    System.config({ baseURL: karma.config.jspm.baseURL?  'base/'+ karma.config.jspm.baseURL : 'base' });\r\n    \r\n\r\n    var stripExtension = typeof karma.config.jspm.stripExtension === 'boolean' ? karma.config.jspm.stripExtension : true;\r\n\r\n    // Prevent immediately starting tests.\r\n    karma.loaded  = function() {\r\n\r\n        if (karma.config.jspm.paths !== undefined &&\r\n            typeof karma.config.jspm.paths === 'object') {\r\n\r\n            System.config({\r\n                paths: karma.config.jspm.paths\r\n            });\r\n        }\r\n\r\n        if (karma.config.jspm.meta !== undefined &&\r\n            typeof karma.config.jspm.meta === 'object') {\r\n            System.config({\r\n                meta: karma.config.jspm.meta\r\n            });\r\n        }\r\n\r\n        // Exclude bundle configurations if useBundles option is not specified\r\n        if (!karma.config.jspm.useBundles) {\r\n            System.bundles = [];\r\n        }\r\n\r\n        // Load everything specified in loadFiles in the specified order\r\n        var promiseChain = Promise.resolve();\r\n        for (var i = 0; i < karma.config.jspm.expandedFiles.length; i++) {\r\n            promiseChain = promiseChain.then((function(moduleName) {\r\n                return function() {\r\n                    return System['import'](moduleName);\r\n                };\r\n            })(extractModuleName(karma.config.jspm.expandedFiles[i])));\r\n        }\r\n\r\n        promiseChain.then(function() {\r\n            karma.start();\r\n        }, function(e) {\r\n            karma.error(e.name + ': ' + e.message);\r\n        });\r\n    };\r\n\r\n    function extractModuleName(fileName) {\r\n        if (stripExtension) {\r\n            return fileName.replace(/\\.js$/, '');\r\n        }\r\n        return fileName;\r\n    }\r\n})(window.__karma__, window.System);`\r\n        };\r\n    }\r\n\r\n\r\n    checkAdapter(karmajspm: KarmaJspmOption, ctx: ITaskContext): string {\r\n\r\n        let templ = karmajspm.karmaloader;\r\n        let defaultTempl = this.getDefaultAdapter();\r\n        if (!templ) {\r\n            templ = defaultTempl;\r\n        } else {\r\n            if (templ.name === defaultTempl.name) {\r\n                console.log(chalk.red('can not rewrite default adapter named: \"adapter\".'));\r\n                templ = defaultTempl;\r\n            }\r\n        }\r\n\r\n        let adapterfile = path.join(__dirname, './adapters', templ.name);\r\n        if (!/.js$/.test(adapterfile)) {\r\n            adapterfile = adapterfile + '.js';\r\n        }\r\n        mkdirp.sync(path.dirname(adapterfile));\r\n        if (!fs.existsSync(adapterfile)) {\r\n            fs.writeFileSync(adapterfile, templ.template, 'utf8')\r\n        }\r\n\r\n        return adapterfile;\r\n    }\r\n}\r\n\r\nfunction getPackageFilePath(packagesPath: string, fileName: string): string {\r\n    let fm = path.join(packagesPath, fileName + '@*.js');\r\n    var exists = glob.sync(fm);\r\n    if (exists && exists.length !== 0) {\r\n        return fm;\r\n    } else {\r\n        return path.join(packagesPath, fileName + '.js');\r\n    }\r\n}\r\n\r\nconst createPattern = function (path: string) {\r\n    return { pattern: path, included: true, served: true, watched: false };\r\n};\r\n\r\nconst createServedPattern = function (pathstr: string, file?) {\r\n    return {\r\n        pattern: pathstr,\r\n        included: file && 'included' in file ? file.included : false,\r\n        served: file && 'served' in file ? file.served : true,\r\n        nocache: file && 'nocache' in file ? file.nocache : false,\r\n        watched: file && 'watched' in file ? file.watched : true\r\n    };\r\n};\r\n"]}