"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function getPackageFilePath(e,t){var n=path.join(e,t+"@*.js"),a=glob.sync(n);return a&&0!==a.length?n:path.join(e,t+".js")}var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},__decorate=function(e,t,n,a){var r,s=arguments.length,o=s<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,n):a;if("object"===("undefined"==typeof Reflect?"undefined":_typeof(Reflect))&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,a);else for(var i=e.length-1;i>=0;i--)(r=e[i])&&(o=(s<3?r(o):s>3?r(t,n,o):r(t,n))||o);return s>3&&o&&Object.defineProperty(t,n,o),o},__metadata=function(e,t){if("object"===("undefined"==typeof Reflect?"undefined":_typeof(Reflect))&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},_=require("lodash"),chalk=require("chalk"),development_core_1=require("development-core"),karma=require("karma"),fs=require("fs"),path=require("path"),glob=require("glob"),mkdirp=require("mkdirp"),url=require("url"),KarmaTest=function(){function e(t){_classCallCheck(this,e),this.info=t}return _createClass(e,[{key:"getInfo",value:function(){return this.info.name=this.info.name||"web-test",this.info}},{key:"setup",value:function(e,t){var n=this,a=e.option.karma||{},r=e.subTaskName(this.getInfo());return t.task(r,function(t){var r=a.configFile||path.join(e.env.root,"./karma.conf.js");r=e.toRootPath(r);var s={};require(r)({set:function(e){s=_.extend(s,e)}}),a.config&&(s=a.config(e)),s=_.extend(s,{singleRun:e.env.release||e.env.deploy||e.env.watch!==!0}),a.basePath?s.basePath=e.toStr(a.basePath):_.isUndefined(s.basePath)&&(s.basePath=e.getDist()),s.basePath=e.toRootPath(s.basePath),a.jspm&&(s.files=s.files||[],s=n.initkarmaJspmPlugin(s,e));var o=new karma.Server(s,function(e){1===e?(console.log(chalk.red("Unit Test failures, exiting process"),", code:",chalk.cyan(e)),t("Unit Test failures, exiting process")):(console.log("Unit Tests passed",", code:",chalk.cyan(e)),t())});o.start()}),r}},{key:"getRelativePaths",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",a={},r=e.getDist(),s=fs.readdirSync(r);_.each(s,function(s){var o=path.join(r,s),i=fs.lstatSync(o);if(i.isDirectory()){var c="/"+s+"/*";a[c]=n+e.toUrl(t,path.join(r,c))}});var o="*";return a[o]=n+e.toUrl(t,path.join(r,o)),a}},{key:"initkarmaJspmPlugin",value:function(e,t){var n=this,a=t.option.karma||{},r=t.getPackage(),s=void 0;s=_.isFunction(a.jspm)?a.jspm(t):_.isBoolean(karma)?{}:a.jspm;var o=e.jspm||{},i=t.toUrl(this.checkAdapter(s,t));s.packages?o.packages=t.toRootPath(t.toStr(s.packages)):!o.packages&&r.jspm&&r.jspm.directories?o.packages=t.toRootPath(r.jspm.directories.packages):o.packages&&(o.packages=t.toRootPath(o.packages)),s.config?o.config=t.toDistSrc(t.toSrc(s.config)):!o.config&&r.jspm?o.config=t.toRootPath(r.jspm.configFile):o.config&&(o.config=t.toDistSrc(o.config)),o.config=_.isString(o.config)?t.toUrl(o.config):_.map(o.config,function(e){return t.toUrl(e)}),o.baseURL=t.toStr(s.baseURL||o.baseURL||""),_.isUndefined(s.cachePackages)||(o.cachePackages=s.cachePackages);var c=path.relative(e.basePath,o.packages),l=!1;/^\.\./.test(c)&&!function(){l=!0;var a=e.basePath=t.getRootPath();o.paths=n.getRelativePaths(t,e.basePath);var r=t.toUrl(a,o.packages)+"/*";o.paths[r]="base/"+r;var i=void 0;i=_.isFunction(s.resource)?s.resource(t):s.resource||["public","asserts"];var c=t.toUrl(a,t.getDist());e.proxies=e.proxies||{},e.files=e.files||[],_.each(_.isString(i)?[i]:i,function(n){e.files.push({pattern:t.toUrl(t.toDistPath(n))+"/**",included:!1});var a=/^\//.test(n)?"base"+n:"base/"+n;e.proxies[a]=url.resolve(c,n)}),console.log("paths: ",o.paths),e.proxies=_.extend(e.proxies,o.paths)}(),o.loadFiles=o.loadFiles||[],o.serveFiles=o.serveFiles||[],s.loadFiles&&(o.loadFiles=o.loadFiles.concat(_.isFunction(s.loadFiles)?s.loadFiles(t):s.loadFiles)),s.serveFiles&&(o.serveFiles=o.serveFiles.concat(_.isFunction(s.serveFiles)?s.serveFiles(t):s.serveFiles)),e.plugins=_.filter(e.plugins||[],function(e){return"karma-jspm"!==e}),e.frameworks=_.filter(e.frameworks||[],function(e){return"jspm"!==e}),e.plugins=e.plugins.concat(_.map(e.frameworks,function(e){return"karma-"+e.toLowerCase()})),e.plugins=e.plugins.concat(_.map(e.reporters,function(e){var t="karma-"+e.toLowerCase()+"-reporter";return r.dependencies[t]||r.devDependencies[t]?t:"karma-"+e})),e.plugins=e.plugins.concat(_.map(e.browsers,function(e){var t="karma-"+e.toLowerCase()+"-launcher";return r.dependencies[t]||r.devDependencies[t]?t:"karma-"+e})),e.plugins=_.uniq(e.plugins);var p=function(e,n,a,r,s){function c(){r.jspm.expandedFiles=_.flatten(_.map(a.loadFiles,function(n){var a=path.join(f,_.isString(n)?n:n.pattern);return e.push(createServedPattern(t.toUrl(a),_.isString(n)?null:n)),_.map(glob.sync(a),function(e){return t.toUrl(f,e)})})),console.log("expandedFiles:",r.jspm.expandedFiles)}console.log("--------------------init karma jspm---------------------\n","base path:",chalk.cyan(n)),a=a||{},a=_.extend(a||{},o),r.jspm=r.jspm||{},void 0!==a.paths&&"object"===_typeof(a.paths)&&(r.jspm.paths=a.paths),void 0!==a.meta&&"object"===_typeof(a.meta)&&(r.jspm.meta=a.meta),r.jspm.useBundles=a.useBundles,r.jspm.stripExtension=a.stripExtension;var p=a.baseURL;r.jspm.baseURL=p||"",console.log("base URL:",chalk.cyan(p));var f=t.toUrl(l?t.getDist():path.join(n,p));console.log("fileBasePath",f);var u=t.toUrl(a.packages),m=t.toUrl(t.toRootPath(t.toStr(a.browser||""))),d=Array.isArray(a.config)?a.config:[a.config];Array.prototype.unshift.apply(e,d.map(function(e){return createPattern(e)})),a.browser&&e.unshift(createPattern(m)),e.unshift(createPattern(i)),e.unshift(createPattern(t.toUrl(getPackageFilePath(u,"system-polyfills.src")))),e.unshift(createPattern(t.toUrl(getPackageFilePath(u,"system.src")))),c(),s.on("file_list_modified",c),_.each(a.serveFiles,function(n){e.push(createServedPattern(t.toUrl(path.join(f,_.isString(n)?n:n.pattern))))});var h=createServedPattern(t.toUrl(path.join(u,"!(system-polyfills.src.js|system.src.js)/**")),{nocache:a.cachePackages!==!0});h.watched=!1,e.push(h),console.log("------------------------complete jspm pattern:\n",e)};return p.$inject=["config.files","config.basePath","config.jspm","config.client","emitter"],e.frameworks.unshift("jspmdev"),e.plugins.unshift({"framework:jspmdev":["factory",p]}),e}},{key:"getDefaultAdapter",value:function(){return{name:"adapter",template:"\n(function(karma, System) {\n    if (!System) {\n        throw new Error('SystemJS was not found. Please make sure you have ' +\n            'initialized jspm via installing a dependency with jspm, ' +\n            'or by running \"jspm dl-loader\".');\n    }\n\n\n    System.config({ baseURL: karma.config.jspm.baseURL?  'base/'+ karma.config.jspm.baseURL : 'base' });\n    \n\n    var stripExtension = typeof karma.config.jspm.stripExtension === 'boolean' ? karma.config.jspm.stripExtension : true;\n\n    // Prevent immediately starting tests.\n    karma.loaded = function() {\n\n        if (karma.config.jspm.paths !== undefined &&\n            typeof karma.config.jspm.paths === 'object') {\n\n            System.config({\n                paths: karma.config.jspm.paths\n            });\n        }\n\n        if (karma.config.jspm.meta !== undefined &&\n            typeof karma.config.jspm.meta === 'object') {\n            System.config({\n                meta: karma.config.jspm.meta\n            });\n        }\n\n        // Exclude bundle configurations if useBundles option is not specified\n        if (!karma.config.jspm.useBundles) {\n            System.bundles = [];\n        }\n\n        // Load everything specified in loadFiles in the specified order\n        var promiseChain = Promise.resolve();\n        for (var i = 0; i < karma.config.jspm.expandedFiles.length; i++) {\n            promiseChain = promiseChain.then((function(moduleName) {\n                return function() {\n                    return System['import'](moduleName);\n                };\n            })(extractModuleName(karma.config.jspm.expandedFiles[i])));\n        }\n\n        promiseChain.then(function() {\n            karma.start();\n        }, function(e) {\n            karma.error(e.name + ': ' + e.message);\n        });\n    };\n\n    function extractModuleName(fileName) {\n        if (stripExtension) {\n            return fileName.replace(/.js$/, '');\n        }\n        return fileName;\n    }\n})(window.__karma__, window.System);"}}},{key:"checkAdapter",value:function(e,t){var n=e.karmaloader,a=this.getDefaultAdapter();n?n.name===a.name&&(console.log(chalk.red('can not rewrite default adapter named: "adapter".')),n=a):n=a;var r=path.join(__dirname,"./adapters",n.name);return/.js$/.test(r)||(r+=".js"),mkdirp.sync(path.dirname(r)),fs.existsSync(r)||fs.writeFileSync(r,n.template,"utf8"),r}}]),e}();KarmaTest=__decorate([development_core_1.task({order:function(e){return{value:2/e,runWay:development_core_1.RunWay.parallel}},oper:development_core_1.Operation.default|development_core_1.Operation.test}),__metadata("design:paramtypes",[Object])],KarmaTest),exports.KarmaTest=KarmaTest;var createPattern=function(e){return{pattern:e,included:!0,served:!0,watched:!1}},createServedPattern=function(e,t){return{pattern:e,included:!!(t&&"included"in t)&&t.included,served:!(t&&"served"in t)||t.served,nocache:!!(t&&"nocache"in t)&&t.nocache,watched:!(t&&"watched"in t)||t.watched}};
//# sourceMappingURL=../sourcemaps/tasks/test.js.map
