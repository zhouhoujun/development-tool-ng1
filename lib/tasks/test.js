"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function getPackageFilePath(e,t){var n=path.join(e,t+"@*.js"),a=glob.sync(n);return a&&0!==a.length?n:path.join(e,t+".js")}var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},__decorate=function(e,t,n,a){var r,o=arguments.length,i=o<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,n):a;if("object"===("undefined"==typeof Reflect?"undefined":_typeof(Reflect))&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,n,a);else for(var s=e.length-1;s>=0;s--)(r=e[s])&&(i=(o<3?r(i):o>3?r(t,n,i):r(t,n))||i);return o>3&&i&&Object.defineProperty(t,n,i),i},__metadata=function(e,t){if("object"===("undefined"==typeof Reflect?"undefined":_typeof(Reflect))&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},_=require("lodash"),chalk=require("chalk"),development_core_1=require("development-core"),karma=require("karma"),fs=require("fs"),path=require("path"),glob=require("glob"),mkdirp=require("mkdirp"),KarmaTest=function(){function e(t){_classCallCheck(this,e),this.info=t}return _createClass(e,[{key:"getInfo",value:function(){return this.info.name=this.info.name||"web-test",this.info}},{key:"setup",value:function(e,t){var n=this,a=e.option.karma,r=e.subTaskName(this.getInfo());return t.task(r,function(t){var r=a.configFile||path.join(e.env.root,"./karma.conf.js");r=e.toRootPath(r);var o={};require(r)({set:function(e){o=_.extend(o,e)}}),a.config&&(o=a.config(e)),o=_.extend(o,{singleRun:e.env.release||e.env.deploy||e.env.watch!==!0}),a.basePath?o.basePath=e.toStr(a.basePath):_.isUndefined(o.basePath)&&(o.basePath=e.getDist()),o.basePath=e.toRootPath(o.basePath),a.jspm&&(o.files=o.files||[],o=n.initkarmaJspmPlugin(o,e));var i=new karma.Server(o,function(e){1===e?(console.log(chalk.red("Unit Test failures, exiting process"),", code:",chalk.cyan(e)),t("Unit Test failures, exiting process")):(console.log("Unit Tests passed",", code:",chalk.cyan(e)),t())});i.start()}),r}},{key:"getRelativePaths",value:function(e,t){var n={},a=e.getDist(),r=fs.readdirSync(a);return _.each(r,function(r){var o=path.join(a,r),i=fs.lstatSync(o);if(i.isDirectory()){var s=r+"/**/*";n[s]=e.toUrl(t,path.join(a,s))}}),console.log("paths: ",n),n}},{key:"initkarmaJspmPlugin",value:function(e,t){var n=t.option.karma,a=t.getPackage(),r=_.isFunction(n.jspm)?n.jspm(t):n.jspm,o={},i=t.toUrl(this.checkAdapter(r,t));r.packages&&(o.packages=t.toRootPath(t.toStr(r.packages))),!o.packages&&a.jspm&&a.jspm.directories&&(o.packages=t.toRootPath(a.jspm.directories.packages)),o.baseURL=t.toStr(r.baseURL||""),o.cachePackages=r.cachePackages;var s=path.relative(e.basePath,o.packages),c=!1;/^\.\./.test(s)&&(c=!0,e.basePath=t.getRootPath(),o.paths=this.getRelativePaths(t,e.basePath),console.log("reset paths:",o.paths)),r.config&&(o.config=t.toSrc(r.config),o.config=_.isString(o.config)?t.toDistPath(o.config):_.map(o.config,function(e){return t.toDistPath(e)})),!o.config&&a.jspm&&(o.config=t.toRootPath(a.jspm.configFile)),o.config&&(o.config=_.isString(o.config)?t.toUrl(o.config):_.map(o.config,function(e){return t.toUrl(e)})),e.plugins=_.filter(e.plugins||[],function(e){return"karma-jspm"!==e}),e.frameworks=_.filter(e.frameworks||[],function(e){return"jspm"!==e}),e.plugins=e.plugins.concat(_.map(e.frameworks,function(e){return"karma-"+e.toLowerCase()})),e.plugins=e.plugins.concat(_.map(e.reporters,function(e){var t="karma-"+e.toLowerCase()+"-reporter";return a.dependencies[t]||a.devDependencies[t]?t:"karma-"+e})),e.plugins=e.plugins.concat(_.map(e.browsers,function(e){var t="karma-"+e.toLowerCase()+"-launcher";return a.dependencies[t]||a.devDependencies[t]?t:"karma-"+e})),e.plugins=_.uniq(e.plugins);var l=function(e,n,a,r,s){function l(){r.jspm.expandedFiles=_.flatten(_.map(a.loadFiles,function(n){var a=path.join(u,_.isString(n)?n:n.pattern);return e.push(createServedPattern(t.toUrl(a),_.isString(n)?null:n)),_.map(glob.sync(a),function(e){return t.toUrl(u,e)})})),console.log("expandedFiles:",r.jspm.expandedFiles)}console.log("--------------------init karma jspm---------------------\n","base path:",chalk.cyan(n)),a=a||{};var p=a.loadFiles||[],f=a.serveFiles||[];a=_.extend(a||{},o),a.loadFiles=_.uniq(a.loadFiles.concat(p)),a.serveFiles=_.uniq(a.serveFiles.concat(f)),r.jspm=r.jspm||{},void 0!==a.paths&&"object"===_typeof(a.paths)&&(r.jspm.paths=a.paths),void 0!==a.meta&&"object"===_typeof(a.meta)&&(r.jspm.meta=a.meta),r.jspm.useBundles=a.useBundles,r.jspm.stripExtension=a.stripExtension;var m=a.baseURL;r.jspm.baseURL=m||"",console.log("base URL:",chalk.cyan(m));var u=t.toUrl(path.join(c?t.getDist():n,m));console.log("fileBasePath",u),r.jspm.paths=a.paths||{};var d=t.toUrl(a.packages),h=t.toUrl(t.toRootPath(t.toStr(a.browser||""))),g=Array.isArray(a.config)?a.config:[a.config];Array.prototype.unshift.apply(e,g.map(function(e){return createPattern(e)})),a.browser&&e.unshift(createPattern(h)),e.unshift(createPattern(i)),e.unshift(createPattern(t.toUrl(getPackageFilePath(d,"system-polyfills.src")))),e.unshift(createPattern(t.toUrl(getPackageFilePath(d,"system.src")))),l(),s.on("file_list_modified",l),_.each(a.serveFiles,function(n){e.push(createServedPattern(t.toUrl(path.join(u,_.isString(n)?n:n.pattern))))});var k=createServedPattern(t.toUrl(path.join(d+"!(system-polyfills.src.js|system.src.js)/**")),{nocache:a.cachePackages!==!0});k.watched=!1,e.push(k),console.log("------------------------complete jspm pattern:\n",e)};return l.$inject=["config.files","config.basePath","config.jspm","config.client","emitter"],e.frameworks.unshift("jspmdev"),e.plugins.unshift({"framework:jspmdev":["factory",l]}),e}},{key:"getDefaultAdapter",value:function(){return{name:"adapter",template:"\n(function(karma, System) {\n    if (!System) {\n        throw new Error('SystemJS was not found. Please make sure you have ' +\n            'initialized jspm via installing a dependency with jspm, ' +\n            'or by running \"jspm dl-loader\".');\n    }\n\n\n    System.config({ baseURL: karma.config.jspm.baseURL?  'base/'+karma.config.jspm.baseURL : 'base' });\n    \n\n    var stripExtension = typeof karma.config.jspm.stripExtension === 'boolean' ? karma.config.jspm.stripExtension : true;\n\n    // Prevent immediately starting tests.\n    karma.loaded = function() {\n\n        if (karma.config.jspm.paths !== undefined &&\n            typeof karma.config.jspm.paths === 'object') {\n\n            System.config({\n                paths: karma.config.jspm.paths\n            });\n        }\n\n        if (karma.config.jspm.meta !== undefined &&\n            typeof karma.config.jspm.meta === 'object') {\n            System.config({\n                meta: karma.config.jspm.meta\n            });\n        }\n\n        // Exclude bundle configurations if useBundles option is not specified\n        if (!karma.config.jspm.useBundles) {\n            System.bundles = [];\n        }\n\n        // Load everything specified in loadFiles in the specified order\n        var promiseChain = Promise.resolve();\n        for (var i = 0; i < karma.config.jspm.expandedFiles.length; i++) {\n            promiseChain = promiseChain.then((function(moduleName) {\n                return function() {\n                    return System['import'](moduleName);\n                };\n            })(extractModuleName(karma.config.jspm.expandedFiles[i])));\n        }\n\n        promiseChain.then(function() {\n            karma.start();\n        }, function(e) {\n            karma.error(e.name + ': ' + e.message);\n        });\n    };\n\n    function extractModuleName(fileName) {\n        if (stripExtension) {\n            return fileName.replace(/.js$/, '');\n        }\n        return fileName;\n    }\n})(window.__karma__, window.System);"}}},{key:"checkAdapter",value:function(e,t){var n=e.karmaloader,a=this.getDefaultAdapter();n?n.name===a.name&&(console.log(chalk.red('can not rewrite default adapter named: "adapter".')),n=a):n=a;var r=path.join(__dirname,"./adapters",n.name);return/.js$/.test(r)||(r+=".js"),mkdirp.sync(path.dirname(r)),fs.existsSync(r)||fs.writeFileSync(r,n.template,"utf8"),r}}]),e}();KarmaTest=__decorate([development_core_1.task({order:{value:.25,runWay:development_core_1.RunWay.parallel},oper:development_core_1.Operation.default|development_core_1.Operation.test}),__metadata("design:paramtypes",[Object])],KarmaTest),exports.KarmaTest=KarmaTest;var createPattern=function(e){return{pattern:e,included:!0,served:!0,watched:!1}},createServedPattern=function(e,t){return{pattern:e,included:!!(t&&"included"in t)&&t.included,served:!(t&&"served"in t)||t.served,nocache:!!(t&&"nocache"in t)&&t.nocache,watched:!(t&&"watched"in t)||t.watched}};
//# sourceMappingURL=../sourcemaps/tasks/test.js.map
