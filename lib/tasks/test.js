"use strict";function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function expandGlob(e,n){return glob.sync(e.pattern||e,{cwd:n})}function getPackageFilePath(e,n){var t=path.join(e,n+"@*.js"),a=glob.sync(t);return a&&0!==a.length?t:path.join(e,n+".js")}var _createClass=function(){function e(e,n){for(var t=0;t<n.length;t++){var a=n[t];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(n,t,a){return t&&e(n.prototype,t),a&&e(n,a),n}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},__decorate=function(e,n,t,a){var r,i=arguments.length,s=i<3?n:null===a?a=Object.getOwnPropertyDescriptor(n,t):a;if("object"===("undefined"==typeof Reflect?"undefined":_typeof(Reflect))&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,n,t,a);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(s=(i<3?r(s):i>3?r(n,t,s):r(n,t))||s);return i>3&&s&&Object.defineProperty(n,t,s),s},__metadata=function(e,n){if("object"===("undefined"==typeof Reflect?"undefined":_typeof(Reflect))&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,n)},_=require("lodash"),chalk=require("chalk"),development_core_1=require("development-core"),karma=require("karma"),fs=require("fs"),path=require("path"),glob=require("glob"),mkdirp=require("mkdirp"),KarmaTest=function(){function e(n){_classCallCheck(this,e),this.info=n}return _createClass(e,[{key:"getInfo",value:function(){return this.info.name=this.info.name||"web-test",this.info}},{key:"setup",value:function(e,n){var t=this,a=e.option,r=e.subTaskName(this.getInfo());return n.task(r,function(n){var r=a.karmaConfigFile||path.join(e.env.root,"./karma.conf.js");r=e.toRootPath(r);var i=null;a.karmaConfig&&(i=a.karmaConfig(e)),i=_.extend(i||{singleRun:e.env.release||e.env.deploy||e.env.watch!==!0},{configFile:r}),a.karmaBasePath?i.basePath=e.toStr(a.karmaBasePath):_.isUndefined(i.basePath)&&(i.basePath=e.getDist()),i.basePath=e.toRootPath(i.basePath),a.karmaJspm&&(i.files=i.files||[],require(r)({set:function(e){i=_.extend(i,e)}}),i=t.initkarmaJspmPlugin(i,e));var s=new karma.Server(i,function(e){1===e?(console.log(chalk.red("Unit Test failures, exiting process"),", code:",chalk.cyan(e)),n("Unit Test failures, exiting process")):(console.log("Unit Tests passed",", code:",chalk.cyan(e)),n())});a.karmaJspm&&s.on("file_list_modified",function(){}),s.start()}),r}},{key:"initkarmaJspmPlugin",value:function(e,n){var t=n.option,a=n.getPackage(),r=_.isFunction(t.karmaJspm)?t.karmaJspm(n):t.karmaJspm,i=n.toUrl(this.checkAdapter(r,n)),s=function(e,t,s,o,c){function l(){o.jspm.expandedFiles=_.flatten(_.map(s.loadFiles,function(a){return e.push(createServedPattern(n.toUrl(path.join(m,_.isString(a)?a:a.pattern)),_.isString(a)?null:a)),expandGlob(a,t)}))}var p=n.getDist();t=n.toDistPath(path.relative(p,t)),console.log("--------------------init karma jspm---------------------\n","base path:",chalk.cyan(t)),s=s||{},r.config&&(s.config=n.toSrc(r.config)),!s.config&&a.jspm?s.config=n.toRootPath(a.jspm.configFile):s.config=_.isString(s.config)?path.join(t,s.config):_.map(s.config,function(e){return path.join(e,e)}),s.config=_.isString(s.config)?n.toUrl(s.config):_.map(s.config,function(e){return n.toUrl(e)}),s.loadFiles=s.loadFiles||[],s.serveFiles=s.serveFiles||[],r.loadFiles&&s.loadFiles.concat(_.isFunction(r.loadFiles)?r.loadFiles(n):r.loadFiles),r.serveFiles&&s.serveFiles.concat(_.isFunction(r.serveFiles)?r.serveFiles(n):r.serveFiles),r.packages&&(s.packages=n.toStr(s.packages||r.packages)),!s.packages&&a.jspm&&a.jspm.directories?s.packages=n.toRootPath(a.jspm.directories.packages):s.packages=path.join(t,s.packages),s.cachePackages=_.isUndefined(r.cachePackages)?s.cachePackages:s.cachePackages,o.jspm=o.jspm||{},void 0!==s.paths&&"object"===_typeof(s.paths)&&(o.jspm.paths=s.paths),void 0!==s.meta&&"object"===_typeof(s.meta)&&(o.jspm.meta=s.meta),o.jspm.useBundles=_.isUndefined(r.useBundles)?s.useBundles:r.useBundles,o.jspm.stripExtension=_.isUndefined(r.stripExtension)?s.stripExtension:r.stripExtension;var f=n.toStr(r.baseURL||s.baseURL),m=n.toUrl(path.join(t,f));o.jspm.baseURL=m,console.log("fileBasePath",m),console.log("base URL:",chalk.cyan(m));var u=n.toUrl(s.packages),d=n.toUrl(n.toRootPath(n.toStr(r.browser||s.browser||""))),g=Array.isArray(s.config)?s.config:[s.config];Array.prototype.unshift.apply(e,g.map(function(e){return createPattern(e)})),s.browser&&e.unshift(createPattern(d)),e.unshift(createPattern(i)),e.unshift(createPattern(n.toUrl(getPackageFilePath(u,"system-polyfills.src")))),e.unshift(createPattern(n.toUrl(getPackageFilePath(u,"system.src")))),l(),c.on("file_list_modified",l),_.each(s.serveFiles,function(t){e.push(createServedPattern(n.toUrl(path.join(m,_.isString(t)?t:t.pattern))))});var h=createServedPattern(u+"!(system-polyfills.src.js|system.src.js)/**",{nocache:s.cachePackages!==!0});h.watched=!1,e.push(h),console.log("------------------------complete jspm pattern:\n",e)};return s.$inject=["config.files","config.basePath","config.jspm","config.client","emitter"],e.plugins=e.plugins||[],e.frameworks=e.frameworks||[],e.plugins=e.plugins.concat(_.map(e.frameworks,function(e){return"karma-"+e.toLowerCase()})),e.plugins=e.plugins.concat(_.map(e.reporters,function(e){var n="karma-"+e.toLowerCase()+"-reporter";return a.dependencies[n]||a.devDependencies[n]?n:"karma-"+e})),e.plugins=e.plugins.concat(_.map(e.browsers,function(e){var n="karma-"+e.toLowerCase()+"-launcher";return a.dependencies[n]||a.devDependencies[n]?n:"karma-"+e})),e.plugins=_.uniq(e.plugins),e.frameworks.indexOf("jspm")>0&&e.frameworks.splice(e.frameworks.indexOf("jspm"),1),e.frameworks.unshift("jspm"),e.plugins.indexOf("karma-jspm")>0&&e.plugins.splice(e.plugins.indexOf("karma-jspm"),1),e.plugins.unshift({"framework:jspm":["factory",s]}),e}},{key:"getDefaultAdapter",value:function(){return{name:"adapter",template:"\n(function(karma, System) {\n    if (!System) {\n        throw new Error('SystemJS was not found. Please make sure you have ' +\n            'initialized jspm via installing a dependency with jspm, ' +\n            'or by running \"jspm dl-loader\".');\n    }\n\n    System.config({ baseURL: karma.config.jspm.baseURL || './' });\n\n    var stripExtension = typeof karma.config.jspm.stripExtension === 'boolean' ? karma.config.jspm.stripExtension : true;\n\n    // Prevent immediately starting tests.\n    karma.loaded = function() {\n\n        if (karma.config.jspm.paths !== undefined &&\n            typeof karma.config.jspm.paths === 'object') {\n\n            System.config({\n                paths: karma.config.jspm.paths\n            });\n        }\n\n        if (karma.config.jspm.meta !== undefined &&\n            typeof karma.config.jspm.meta === 'object') {\n            System.config({\n                meta: karma.config.jspm.meta\n            });\n        }\n\n        // Exclude bundle configurations if useBundles option is not specified\n        if (!karma.config.jspm.useBundles) {\n            System.bundles = [];\n        }\n\n        // Load everything specified in loadFiles in the specified order\n        var promiseChain = Promise.resolve();\n        for (var i = 0; i < karma.config.jspm.expandedFiles.length; i++) {\n            promiseChain = promiseChain.then((function(moduleName) {\n                return function() {\n                    return System['import'](moduleName);\n                };\n            })(extractModuleName(karma.config.jspm.expandedFiles[i])));\n        }\n\n        promiseChain.then(function() {\n            karma.start();\n        }, function(e) {\n            karma.error(e.name + ': ' + e.message);\n        });\n    };\n\n    function extractModuleName(fileName) {\n        if (stripExtension) {\n            return fileName.replace(/.js$/, '');\n        }\n        return fileName;\n    }\n})(window.__karma__, window.System);"}}},{key:"checkAdapter",value:function(e,n){var t=e.karmaloader,a=this.getDefaultAdapter();t?t.name===a.name&&(console.log(chalk.red('can not rewrite default adapter named: "adapter".')),t=a):t=a;var r=path.join(__dirname,"./adapters",t.name);return/.js$/.test(r)||(r+=".js"),mkdirp.sync(path.dirname(r)),fs.existsSync(r)||fs.writeFileSync(r,t.template,"utf8"),r}}]),e}();KarmaTest=__decorate([development_core_1.task({order:{value:.25,runWay:development_core_1.RunWay.parallel},oper:development_core_1.Operation.default|development_core_1.Operation.test}),__metadata("design:paramtypes",[Object])],KarmaTest),exports.KarmaTest=KarmaTest;var createPattern=function(e){return{pattern:e,included:!0,served:!0,watched:!1}},createServedPattern=function(e,n){return{pattern:e,included:!!(n&&"included"in n)&&n.included,served:!(n&&"served"in n)||n.served,nocache:!!(n&&"nocache"in n)&&n.nocache,watched:!(n&&"watched"in n)||n.watched}};
//# sourceMappingURL=../sourcemaps/tasks/test.js.map
