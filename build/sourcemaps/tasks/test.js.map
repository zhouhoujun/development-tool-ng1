{"version":3,"sources":["tasks/test.js"],"names":["__decorate","decorators","target","key","desc","c","arguments","length","r","Object","getOwnPropertyDescriptor","d","Reflect","decorate","i","defineProperty","__metadata","k","v","metadata","_","require","chalk","development_core_1","karam","path","KaramTest","info","name","ctx","gulp","option","tkn","subTaskName","getInfo","task","callback","karmaConfigFile","join","env","root","isAbsolute","cfg","karmaConfig","karamjspm","files","frameworks","extend","singleRun","release","deploy","watch","configFile","karmaBasePath","basePath","toStr","isUndefined","getDist","serve","Server","code","console","log","red","cyan","on","start","order","value","runWay","RunWay","parallel","oper","Operation","default","test","exports","createPattern","pattern","included","served","watched","createServedPattern","file","nocache"],"mappings":"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","file":"../../tasks/test.js","sourcesContent":["\"use strict\";\nvar __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\n    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\n    if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\n    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n    return c > 3 && r && Object.defineProperty(target, key, r), r;\n};\nvar __metadata = (this && this.__metadata) || function (k, v) {\n    if (typeof Reflect === \"object\" && typeof Reflect.metadata === \"function\") return Reflect.metadata(k, v);\n};\nconst _ = require('lodash');\nconst chalk = require('chalk');\n// import * as path from 'path';\nconst development_core_1 = require('development-core');\n// import * as chalk from 'chalk';\nconst karam = require('karma');\nconst path = require('path');\nlet KaramTest = class KaramTest {\n    constructor(info) {\n        this.info = info;\n    }\n    getInfo() {\n        this.info.name = this.info.name || 'test';\n        return this.info;\n    }\n    setup(ctx, gulp) {\n        let option = ctx.option;\n        let tkn = ctx.subTaskName(this.getInfo());\n        gulp.task(tkn, (callback) => {\n            let karmaConfigFile = option.karmaConfigFile || path.join(ctx.env.root, './karma.conf.js');\n            if (!path.isAbsolute(karmaConfigFile)) {\n                karmaConfigFile = path.join(ctx.env.root, karmaConfigFile);\n            }\n            let cfg = null;\n            if (option.karmaConfig) {\n                cfg = option.karmaConfig(ctx);\n            }\n            if (option.karamjspm) {\n                cfg.files = cfg.files || [];\n                cfg.frameworks;\n            }\n            cfg = _.extend(cfg || { singleRun: ctx.env.release || ctx.env.deploy || ctx.env.watch !== true }, {\n                configFile: karmaConfigFile\n            });\n            if (option.karmaBasePath) {\n                cfg.basePath = ctx.toStr(option.karmaBasePath);\n            }\n            else if (_.isUndefined(cfg.basePath)) {\n                cfg.basePath = ctx.getDist();\n            }\n            let serve = new karam.Server(cfg, (code) => {\n                if (code === 1) {\n                    console.log(chalk.red('Unit Test failures, exiting process'), ', code:', chalk.cyan(code));\n                    callback('Unit Test failures, exiting process');\n                }\n                else {\n                    console.log('Unit Tests passed', ', code:', chalk.cyan(code));\n                    callback();\n                }\n            });\n            if (option.karamjspm) {\n                serve.on('file_list_modified', () => {\n                });\n            }\n            serve.start();\n        });\n        return tkn;\n    }\n};\nKaramTest = __decorate([\n    development_core_1.task({\n        order: { value: 0.25, runWay: development_core_1.RunWay.parallel },\n        oper: development_core_1.Operation.default | development_core_1.Operation.test\n    }), \n    __metadata('design:paramtypes', [Object])\n], KaramTest);\nexports.KaramTest = KaramTest;\nconst createPattern = function (path) {\n    return { pattern: path, included: true, served: true, watched: false };\n};\nconst createServedPattern = function (path, file) {\n    return {\n        pattern: path,\n        included: file && 'included' in file ? file.included : false,\n        served: file && 'served' in file ? file.served : true,\n        nocache: file && 'nocache' in file ? file.nocache : false,\n        watched: file && 'watched' in file ? file.watched : true\n    };\n};\n"]}